-- PostgreSQL / Supabase schema for Tably
-- Run this file in Supabase SQL Editor

begin;

-- Drop in reverse dependency order
drop table if exists order_items cascade;
drop table if exists orders cascade;
drop table if exists notifications cascade;
drop table if exists menu_items cascade;
drop table if exists categories cascade;
drop table if exists event_tickets cascade;
drop table if exists event_orders cascade;
drop table if exists booking_orders cascade;
drop table if exists booking_attempts cascade;
drop table if exists bookings cascade;
drop table if exists tables cascade;
drop table if exists zones cascade;
drop table if exists users cascade;
drop table if exists used_slip_refs cascade;
drop table if exists settings cascade;
drop table if exists ui_texts cascade;

create table users (
  id integer generated by default as identity primary key,
  line_id varchar(255) not null unique,
  display_name varchar(255) not null,
  picture_url varchar(255),
  role varchar(20) not null default 'user',
  created_at timestamptz not null default now()
);

create table zones (
  id integer generated by default as identity primary key,
  name varchar(255) not null,
  description text,
  price numeric(10, 2) default 0.00,
  booking_fee integer
);

create table tables (
  id integer generated by default as identity primary key,
  table_number varchar(50) not null,
  capacity integer not null,
  status varchar(50) not null default 'available',
  zone_id integer references zones(id) on delete set null
);

create index idx_tables_zone_id on tables(zone_id);

create table bookings (
  id integer generated by default as identity primary key,
  user_id integer not null references users(id),
  table_id integer not null references tables(id),
  booking_date date not null,
  status varchar(50) not null default 'confirmed',
  created_at timestamptz not null default now(),
  slip_image_url varchar(255),
  is_hidden_from_user boolean default false,
  order_id varchar(255),
  check_in_token varchar(255),
  check_in_token_expires_at timestamptz,
  total_price numeric(10, 2) not null default 0.00
);

create unique index table_id_booking_date_unique
  on bookings(table_id, booking_date);
create index idx_booking_lookup on bookings(table_id, booking_date, status);
create index idx_booking_user on bookings(user_id);
create index idx_bookings_table_id on bookings(table_id);
create index idx_bookings_user_id on bookings(user_id);
create index idx_bookings_date_status on bookings(booking_date, status);

create table booking_attempts (
  id integer generated by default as identity primary key,
  user_id integer not null references users(id),
  table_id integer not null references tables(id),
  session_id varchar(255) not null,
  status varchar(20) not null default 'pending'
    check (status in ('pending', 'confirmed', 'cancelled')),
  created_at timestamptz default now()
);

create index idx_booking_attempts_table_id on booking_attempts(table_id);
create index idx_booking_attempts_user_id on booking_attempts(user_id);
create index idx_booking_attempts_created_at on booking_attempts(created_at);

create table booking_orders (
  id varchar(64) primary key,
  user_id integer not null references users(id),
  booking_date date not null,
  total_fee numeric(10, 2) not null default 0.00,
  status varchar(20) not null default 'pending'
    check (status in ('pending', 'paid', 'expired', 'cancelled')),
  expires_at timestamptz,
  ref_nbr varchar(64),
  paid_at timestamptz,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

create table categories (
  id integer generated by default as identity primary key,
  name varchar(255) not null,
  description text
);

create table events (
  id integer generated by default as identity primary key,
  image_url varchar(255) not null,
  alt_text varchar(255),
  link_url varchar(255),
  sort_order integer default 0,
  title varchar(255),
  date date,
  description text,
  price numeric(10, 2) not null default 0.00,
  total_tickets integer not null default 0,
  tickets_sold integer not null default 0,
  is_active boolean not null default true
);

create table event_orders (
  id varchar(36) primary key,
  user_id integer not null references users(id),
  event_id integer not null references events(id),
  quantity integer not null,
  status varchar(20) not null default 'pending'
    check (status in ('pending', 'paid', 'failed', 'expired', 'cancelled')),
  created_at timestamptz not null default now(),
  expires_at timestamptz not null,
  slip_image_url varchar(255),
  ref_nbr varchar(255),
  paid_at timestamptz,
  total_price numeric(10, 2) not null default 0.00
);

create index idx_event_orders_event_id on event_orders(event_id);
create index idx_event_orders_user_id on event_orders(user_id);
create index idx_event_orders_created_at on event_orders(created_at);

create table event_tickets (
  id varchar(255) primary key,
  event_id integer not null references events(id) on delete cascade,
  user_id integer not null references users(id),
  purchase_date timestamptz not null default now(),
  status varchar(20) not null default 'valid'
    check (status in ('valid', 'used', 'cancelled')),
  qr_code_data text,
  created_at timestamptz not null default now()
);

create index idx_event_tickets_event_id on event_tickets(event_id);
create index idx_event_tickets_user_id on event_tickets(user_id);
create index idx_event_tickets_created_at on event_tickets(created_at);

create table menu_items (
  id integer generated by default as identity primary key,
  name varchar(255) not null,
  description text,
  price numeric(10, 2) not null,
  image_url varchar(255),
  category_id integer references categories(id) on delete set null,
  is_available boolean not null default true
);

create index idx_menu_items_category_id on menu_items(category_id);

create table notifications (
  id integer generated by default as identity primary key,
  user_id integer not null references users(id) on delete cascade,
  message text not null,
  is_read boolean not null default false,
  created_at timestamptz not null default now()
);

create index idx_notifications_user_id on notifications(user_id);

create table orders (
  id integer generated by default as identity primary key,
  booking_id integer not null references bookings(id) on delete cascade,
  user_id integer not null references users(id) on delete cascade,
  total_price numeric(10, 2) not null,
  status varchar(20) not null default 'pending'
    check (status in ('pending', 'preparing', 'completed', 'cancelled')),
  created_at timestamptz not null default now()
);

create index idx_orders_booking_id on orders(booking_id);
create index idx_orders_user_id on orders(user_id);

create table order_items (
  id integer generated by default as identity primary key,
  order_id integer not null references orders(id) on delete cascade,
  menu_item_id integer not null references menu_items(id) on delete cascade,
  quantity integer not null,
  price numeric(10, 2) not null
);

create index idx_order_items_order_id on order_items(order_id);
create index idx_order_items_menu_item_id on order_items(menu_item_id);

create table settings (
  setting_key varchar(255) primary key,
  setting_value text
);

create table used_slip_refs (
  id integer generated by default as identity primary key,
  ref_nbr varchar(255) not null unique,
  created_at timestamptz default now()
);

create table ui_texts (
  text_key varchar(128) primary key,
  text_value text not null default '',
  updated_at timestamptz not null default now()
);

-- Seed data
insert into events (
  id, image_url, alt_text, link_url, sort_order, title, date, description, price, total_tickets, tickets_sold, is_active
) values
  (6, 'https://example.com/events/three-man-down.jpg', '', null, 0, 'Three Man Down', '2026-01-01', '', 10.00, 1000, 1, true),
  (7, 'https://example.com/events/saran.jpg', '', null, 0, 'Saran', '2025-11-28', '', 20.00, 500, 1, true),
  (8, 'https://example.com/events/zentyarb.webp', '', null, 0, 'ZentYarb', '2025-11-21', '', 10.00, 100, 0, true)
on conflict (id) do nothing;

insert into settings (setting_key, setting_value) values
  ('booking_enabled', 'true'),
  ('booking_fee', '10'),
  ('layoutImageUrl', 'https://i.ibb.co/yjmdRHD/T-1-1.png'),
  ('max_bookings_per_user', '2'),
  ('promptpayAccount', '0931617671'),
  ('transfer_fee', '10')
on conflict (setting_key) do update
set setting_value = excluded.setting_value;

insert into zones (id, name, description, price, booking_fee) values
  (6, 'A', null, 0.00, 10),
  (7, 'B', null, 0.00, 10),
  (8, 'C', null, 0.00, 10),
  (9, 'D', null, 0.00, 10),
  (10, 'VIP', null, 0.00, 10)
on conflict (id) do nothing;

insert into tables (id, table_number, capacity, status, zone_id) values
  (9, 'A1', 4, 'available', 6),
  (10, 'A2', 4, 'available', 6),
  (11, 'A3', 4, 'available', 6),
  (12, 'A4', 4, 'available', 6),
  (13, 'B1', 6, 'available', 7),
  (14, 'B2', 6, 'available', 7),
  (15, 'B3', 6, 'available', 7),
  (17, 'C1', 6, 'available', 8),
  (18, 'C2', 6, 'available', 8),
  (22, 'D1', 4, 'available', 9),
  (23, 'D2', 4, 'available', 9),
  (24, 'VIP1', 8, 'available', 10),
  (25, 'VIP2', 8, 'available', 10),
  (26, 'VIP3', 8, 'available', 10)
on conflict (id) do nothing;

-- Keep identity sequences aligned with seeded ids
select setval(pg_get_serial_sequence('zones', 'id'), coalesce((select max(id) from zones), 1), true);
select setval(pg_get_serial_sequence('tables', 'id'), coalesce((select max(id) from tables), 1), true);
select setval(pg_get_serial_sequence('events', 'id'), coalesce((select max(id) from events), 1), true);

commit;
